---
title: "webhacking.kr 7ë²ˆ ë¬¸ì œ"
date: 2019-11-04
excerpt: "MySQLê³¼ PHP, SQL ì¸ì ì…˜"
categories : "webhacking"
comments: true
header:
    teaser: "https://raw.githubusercontent.com/TERADA-DANTE/TERADA-DANTE.github.io/master/_images/teaser/webhacking_teaser.jpg"
toc: true 
toc_label: "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ..." 
toc_icon: "chess-rook"
toc_sticky: true
---

## ê°œìš”
ì´ë²ˆ í¬ìŠ¤íŠ¸ëŠ” webhacking.kr 7ë²ˆ ë¬¸ì œì…ë‹ˆë‹¤. ë°°ì ì€ 300ì ì…ë‹ˆë‹¤.
í˜ì´ì§€ì˜ ì²« í™”ë©´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![7_1](https://i.imgur.com/GzYVwcH.png)

`View-source`ë¥¼ í†µí•´ í˜ì´ì§€ì˜ ì†ŒìŠ¤ì½”ë“œğŸ“ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

~~~php
<?php
$go=$_GET['val'];

if(!$go) { 
    echo("<meta http-equiv=refresh content=0;url=index.php?val=1>"); 
}
...
if(preg_match("/2|-|\+|from|_|=|\\s|\*|\//i",$go)) 
    exit("Access Denied!");

$db = dbconnect();
$rand=rand(1,5);
if($rand==1){
  $result=mysqli_query($db,"select lv from chall7 where lv=($go)") or die("nice try!");
}
if($rand==2){
  $result=mysqli_query($db,"select lv from chall7 where lv=(($go))") or die("nice try!");
}
if($rand==3){
  $result=mysqli_query($db,"select lv from chall7 where lv=((($go)))") or die("nice try!");
}
if($rand==4){
  $result=mysqli_query($db,"select lv from chall7 where lv=(((($go))))") or die("nice try!");
}
if($rand==5){
  $result=mysqli_query($db,"select lv from chall7 where lv=((((($go)))))") or die("nice try!");
}

$data=mysqli_fetch_array($result);

if(!$data[0]) { echo("query error"); exit(); }
if($data[0]==1){
  echo("<input type=button style=border:0;bgcolor='gray' value='auth' onclick=\"alert('Access_Denied!')\"><p>");
}elseif($data[0]==2){
  echo("<input type=button style=border:0;bgcolor='gray' value='auth' onclick=\"alert('Hello admin')\"><p>");
  solve(7);
}
?>
~~~

ë¬¸ì œì˜ KeyğŸ”‘ëŠ” `$go` ê°’ì— ìˆìŠµë‹ˆë‹¤. [ë¶„ì„](#ë¶„ì„)ì„ í†µí•´ ì†ŒìŠ¤ì½”ë“œì— ì‚¬ìš©ëœ í•¨ìˆ˜ë“±ì„ ë¶„ì„í•˜ê³  [í’€ì´](#í’€ì´)ì—ì„œ ì‹¤ì œë¡œ ì–´ë–¤ valueë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤.

## ë¶„ì„
### preg_match()
<a class="PHP">PHP</a><a class="PHPver">7.0</a>  
preg_match()ëŠ” ì •ê·œì‹ í‘œí˜„ ì¼ì¹˜ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

#### preg_match() ë¬¸ë²•
~~~php
preg_match ( string $pattern , string $subject );
~~~
**Note**: Optional argumentëŠ” ìƒëµí•˜ì˜€ìŠµë‹ˆë‹¤. Optional argumentì— ê´€í•˜ì—¬ëŠ” [ì—¬ê¸°ë¥¼](https://www.php.net/manual/en/function.preg-match.php) ì°¸ì¡°.

`$pattern`: ì •ê·œí‘œí˜„ì‹, íŒ¨í„´(/ë¡œ ì‹œì‘í•˜ì—¬ ëë‚˜ëŠ” ë¬¸ìì—´)

`$subject`: ê²€ìƒ‰ ëŒ€ìƒì´ ë  ë¬¸ìì—´

#### preg_match() ì˜ˆì œ
~~~php
if(preg_match("/[0-9]|\s|\/|^a/i",'123 Aloha ///')) 
    echo('Matched!')    //Matched!
~~~
  1. `[0-9]` : 0-9ì— í•´ë‹¹í•˜ëŠ” ìˆ«ì
  2. `\s` : ê³µë°±
  3. `\/` : /(\(ë°±ìŠ¤í˜ì´ìŠ¤)ëŠ” Escape letter[^1])
  4. `^a` : ë¬¸ìì—´ì˜ ì‹œì‘(^)ì´ a 
  5. `/ /i`: ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆí•¨

ì •ê·œ(í‘œí˜„)ì‹ì—ëŠ” ì—¬ê¸°ì—ì„œ ë‹¤ë£° ìˆ˜ ì—†ì„ë§Œí¼ ë‹¤ì–‘í•œ í‘œí˜„ë“¤ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë” ë‹¤ì–‘í•œ ì •ê·œ(í‘œí˜„)ì‹ì—ì„œëŠ” [ì—¬ê¸°](https://www.tutorialspoint.com/php/php_regular_expression.htm)ë¥¼ ì°¸ì¡°í•´ì£¼ì„¸ìš”.

### exit()
<a class="PHP">PHP</a><a class="PHPver">7.0</a>  
exit()ëŠ” ë©”ì„¸ì§€ë¥¼ ì¶œë ¥í•˜ë©° ì´í›„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.

#### exit() ë¬¸ë²•
~~~php
exit ([ string $status ] )
~~~
`$status`: ì¶œë ¥í•  ë©”ì‹œì§€

#### exit() ì˜ˆì œ

~~~php 
for($i=0;$i<5;$i++){
    echo('Hello ');
    if($i==2){
    	exit();
	}
}                       //Hello Hello Hello
  	echo ('printed?');  // ì¶œë ¥ë˜ì§€ ì•ŠìŒ
~~~

### mysqli_query()
<a class="PHP">PHP</a><a class="PHPver">7.0</a>  <a class="MySQL">MySQL</a><a class="MySQLver">8.0</a>  

mysqli_query() ëŠ” mysqli_connect ë¥¼ í†µí•´ ì—°ê²°ëœ ê°ì²´ë¥¼ ì´ìš©í•˜ì—¬ MySQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ë¬¸ë²•ê³¼ ì˜ˆì œëŠ” ìƒëµí•©ë‹ˆë‹¤.

### die()
die()ëŠ” [exit()](#exit)ì™€ ê°™ìŠµë‹ˆë‹¤. ë¬¸ë²•ê³¼ ì˜ˆì œëŠ” ìƒëµí•©ë‹ˆë‹¤.
â€‹
## í’€ì´
ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë³¸ í’€ì´ì—ì„œëŠ” ì†ŒìŠ¤ì½”ë“œë¥¼ ê±°ê¾¸ë¡œ ë¶„ì„í•´ê°€ë©´ì„œ ì„¤ëª…ì„ ì§„í–‰í•©ë‹ˆë‹¤. 

ë¬¸ì œì˜ ëª©í‘œëŠ” *line 35*ì˜ solve(7)ì„ ì‹¤í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì†ŒìŠ¤ ì½”ë“œë¥¼ ì°¸ì¡°í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
~~~php
elseif($data[0]==2){
  echo("<input type=button style=border:0;bgcolor='gray' value='auth' onclick=\"alert('Hello admin')\"><p>");
  solve(7);
}
~~~

ì¦‰, solve(7)ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” **$data[0]ì´ 2**ê°€ ë˜ì–´ì•¼í•©ë‹ˆë‹¤.

*line 29*ì—ì„œëŠ” dataì— ë°°ì—´ë¡œ ê°’ì„ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.

~~~php
$data = mysqli_fetch_array($result);
~~~

ì¦‰ $resultì˜ ê°’ì„ 2ë¡œ ë§Œë“¤ì–´ì„œ $dataì— ì €ì¥í•˜ë©´ ë©ë‹ˆë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ ë” ì˜¬ë¼ê°€ì„œ í™•ì¸í•´ë³´ë©´, *line 23~25*ì—ì„œ resultê°’ì„ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

~~~php
if($rand==1){
  $result=mysqli_query($db,"select lv from chall7 where lv=($go)") or die("nice try!");
}
~~~

rand(1, 5)ë¥¼ ì‚¬ìš©í•˜ì—¬ 20%ì˜ í™•ë¥ ë¡œ ìœ„ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ì´ ë©ë‹ˆë‹¤. ì €ëŠ” `$rand`ê°€ 1ì¸ ê²½ìš°ë¥¼ ê³µëµí•˜ì˜€ìŠµë‹ˆë‹¤. `$rand`ê°’ì— ë”°ë¼ í•„ìš”í•œ ê´„í˜¸ì˜ ê°œìˆ˜ê°€ ë‹¤ë¦…ë‹ˆë‹¤.

`$result`ì—ëŠ”, die()ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ì´ìƒ, MySQL ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì–´ ë°˜í™˜ëœ ê²°ê³¼ê°€ ì €ì¥ë©ë‹ˆë‹¤.
~~~
SELECT lv FROM chall7 WHERE lv=($go);
~~~
ì¦‰, ìœ„ ì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ ì €ì¥ë  ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ `$go`ê°’ì„ ì ì ˆíˆ ì¡°ì‘í•˜ì—¬ `$result`ì— ì €ì¥ë˜ëŠ” ê°’ì„ 2ë¡œ ë§Œë“¤ë©´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

*line 2~6*ì—ì„œ `$go`ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
~~~php
$go=$_GET['val'];
if(!$go) { 
    echo("<meta http-equiv=refresh content=0;url=index.php?val=1>"); 
}
~~~
ì¦‰ í˜ì´ì§€ì— ì²˜ìŒ ì ‘ê·¼í–ˆì„ë•Œ `$go`ëŠ” 1ë¡œ ì´ˆê¸°í™”ë˜ê³  ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í˜ì´ì§€ì˜ urlë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.

![7_2](https://i.imgur.com/rxjm7Ct.png)

ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ìœ„ ê°’ì„ ì¡°ì‘í•˜ì—¬(`$go`) ë¬¸ì œë¥¼ í•´ê²°í•˜ë©´ ë©ë‹ˆë‹¤.

ì´ì œ `$go`ë¥¼ ì¡°ì‘í•˜ì—¬ ì›í•˜ëŠ” ê²°ê³¼ë¥¼ `$result`ì— ì €ì¥í•´ì•¼í•©ë‹ˆë‹¤.
~~~php
SELECT lv FROM chall7 WHERE lv=($go);
~~~
ìœ„ì˜ ì¿¼ë¦¬ë¥¼ ì—¼ë‘ì— ë‘ê³  ë‹¤ìŒê³¼ ê°™ì´ ê°’ì„ ì…ë ¥í•˜ë©´ ë ê¹Œìš”?

webhacking.kr/challenge/web-07/index.php?val=<a class="purple">2</a>

![7_3](https://i.imgur.com/XaOQ3G7.png)

`Access Denied`ê°€ ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.ğŸƒ

ìœ„ urlì€ ë‹¤ìŒê³¼ ê°™ì€ Queryë¥¼ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

SELECT lv FROM chall7 WHERE lv=(<a class="purple">2</a>);

ìœ„ QueryëŠ” ì •ë‹µì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ëŠ” chall7 tableì˜ lv ì»¬ëŸ¼ì„ ì•Œì§€ ëª»í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë§í•˜ë©´ chall7 í…Œì´ë¸”ì˜ lvì´ 2ì¸ ì»¬ëŸ¼ì— ì–´ë–¤ ê°’ì´ ë“¤ì–´ìˆëŠ”ì§€ ëª¨ë¦…ë‹ˆë‹¤. 

ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì§ì ‘ `2`ë¼ëŠ” ê°’ì„ ë„£ì–´ì¤„ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ Queryë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

SELECT lv FROM chall7 WHERE lv=(<a class="purple">0) UNION SELECT 2</a>;

![7_4](https://i.imgur.com/yJGdnWT.png)

ì´ë²ˆì—ë„ `Access Denied`ê°€ ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìœ ëŠ” *line 10*ì—ì„œ [preg_match()](#preg_match())ë¥¼ ì‚¬ìš©í•˜ì—¬ `$go`ë¥¼ í•„í„°ë§í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì ì‹œ *line 10*ì—ì„œ í•„í„°ë§í•˜ëŠ” ë¬¸ìë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

~~~php
if(preg_match("/2|-|\+|from|_|=|\\s|\*|\//i",$go)) 
    exit("Access Denied!");
~~~
1. 2
2. \-
3. 1ê°œ ì´ìƒì˜ \
4. from
5. _
6. =
7. ëª¨ë“  ì¢…ë¥˜ì˜ ê³µë°±
8. -ê°œ ì´ìƒì˜ \
9. /
10. ëª¨ë“  ì•ŒíŒŒë²³ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆí•¨

ìœ„ í•„í„°ë§ì„ í”¼í•´ì„œ ì‘ì„±í•œ ìµœì¢…ì ì¸ QueryëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

SELECT lv FROM chall7 WHERE lv=(<a class="purple">0)UNION(SELECT(CEIL(1.1)))%23</a><strike>) die(...);</strike>

ê³µë°±ì„ ìš°íšŒí•˜ê¸° ìœ„í•˜ì—¬ ê´„í˜¸ë¥¼ ì‚¬ìš©í•˜ì˜€ê³ , ìˆ«ì 2ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•˜ì—¬ ë‚´ì¥í•¨ìˆ˜ ceil()[^2]ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ %23(#)ì„ ì‚¬ìš©í•˜ì—¬ ë’¤ì˜ die()ë¥¼ ì£¼ì„ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.

![7_5](https://i.imgur.com/zjzVfCk.png)
ìœ„ì™€ ê°™ì´ URLì„ ì…ë ¥í•˜ê³  ì•½ 5íšŒ(20%ì˜ í™•ë¥ ) ìƒˆë¡œê³ ì¹¨ì„ í•˜ë©´ ë¬¸ì œ7ì€ Clearë©ë‹ˆë‹¤. ğŸ’¯

### ë§ˆì¹˜ë©°
ì„¤ëª…ì˜ ë¶€ì¡±í•¨ì„ ëŠë‚ë‹ˆë‹¤. ì „ë¬¸ê°€ê°€ ì•„ë‹ˆì§€ë§Œ ëˆ„êµ°ê°€ì˜ ê¶ê¸ˆì¦ì— ì¡°ê¸ˆì´ë¼ë„ ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ í•©ë‹ˆë‹¤.

----
[^1]: `\`ë’¤ì˜ ë¬¸ìê°€ ìˆœìˆ˜í•œ ë¬¸ìì—´ë¡œ í•´ì„ë˜ê²Œ í•´ì£¼ëŠ” íšŒí”¼ ë¬¸ì 

[^2]: ì†Œìˆ˜ì ì„ ì˜¬ë¦° ì •ìˆ˜ë¥¼ ë°˜í™˜

<style>
.purple{
    color: #950fcd;
}
blockquote{
    border-left: 0.25em solid #266477;
}
</style>
<style>
.page__content h1,
.page__content h2
{
    padding-bottom: 0.5em;
    border-bottom: 1px solid #89ddff;
}
</style>

<style>
    p{
        margin-block-start: 0em;
        margin-block-end: 0em;
        margin-inline-start: 0px;
        margin-inline-end: 0px;
        margin-top:0px;
        margin-bottom: 0px;
    }
</style>
<style>
        .MySQL {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #52809c;
            color: #f8fafc;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
            content: "MySQL"
        }

        .MySQLver {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #f8981d;
            color: #f8fafc;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }
</style>
<style>
        .Javascript {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #f2e21b;
            color: #222;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .Javascriptver {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #000000c7;
            color: #f8fafc;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }
</style>
<style>
        .PHP {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #777bb3;
            color: #f8fafc;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
            content: "MySQL"
        }

        .PHPver {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #000000c7;
            color: #f8fafc;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }
</style>
<style>
        .Python {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #0277bd;
            color: #f8fafc;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .Pythonver {
            display: inline;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 2px;
            font-size: 0.6em;
            text-align: center;
            background-color: #ffc107;
            color: #f8fafc;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }
</style>
<style>
.page h1:before {
    padding-right: 0.3em;
    color: #9ddcff;
    content: "/";
}

.page h2:before {
    padding-right: 0.3em;
    color: #9ddcff;
    content: "//";
}

.page h3:before {
    padding-right: 0.3em;
    color: #9ddcff;
    content: "///";
}

.page h4:before {
    padding-right: 0.3em;
    color: #9ddcff;
    content: "////";
}

p>code,
a>code,
li>code,
figcaption>code,
td>code {
    padding-left: 0.18rem;
    padding-right: 0.18rem;
    padding-top: 0.09rem;
    font-size: 0.8em;
    background: #fff;
    color: #5283f3;
    border: solid 1px #e1e4e5;
    border-radius: 0px;
    font-family: open sans,clear sans,helvetica neue,Helvetica,Arial,sans-serif;
    font-weight: bold;
}
</style>
